<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siliconv Replay Converter</title>
    <style>
        :root { --primary: #00e676; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); text-align: center; width: 90%; max-width: 450px; border: 1px solid #333; }
        h1 { color: var(--primary); margin: 0 0 0.5rem 0; font-size: 2.5rem; letter-spacing: -1px; }
        p { color: #888; margin-bottom: 2rem; }
        
        #drop-zone { border: 2px dashed #444; padding: 50px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; background: #181818; margin-bottom: 20px; }
        #drop-zone:hover { border-color: var(--primary); background: #222; transform: translateY(-2px); }
        #drop-zone.active { border-color: var(--primary); background: #252525; }

        #status { margin-top: 20px; padding: 15px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; min-height: 20px; transition: 0.3s; }
        .error { background: rgba(255, 82, 82, 0.1); color: #ff5252; border: 1px solid rgba(255, 82, 82, 0.3); }
        .success { background: rgba(0, 230, 118, 0.1); color: var(--primary); border: 1px solid rgba(0, 230, 118, 0.3); }
        
        .loader { display: none; width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>Siliconv</h1>
    <p>Web Replay Engine</p>

    <div id="drop-zone">
        <div id="drop-text">Загрузка движка...</div>
        <div class="loader" id="loader"></div>
    </div>
    
    <input type="file" id="file-input" style="display: none">

    <div id="status">Пожалуйста, подождите...</div>
</div>

<script type="module">
    // Импортируем инициализатор и функцию из скомпилированного пакета
    import init, { process_replay_data } from './pkg/siliconv.js';

    const dropZone = document.getElementById('drop-zone');
    const dropText = document.getElementById('drop-text');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');

    // Функция обновления статуса
    function updateStatus(msg, type = '') {
        status.innerText = msg;
        status.className = type;
        loader.style.display = (msg.includes('Обработка') || msg.includes('Загрузка')) ? 'block' : 'none';
    }

    async function startApp() {
        try {
            // Инициализация WASM
            await init();
            updateStatus('Движок готов к работе');
            dropText.innerText = 'Нажми или перетащи файл (.slc)';
        } catch (err) {
            updateStatus('Критическая ошибка: ' + err, 'error');
            console.error("WASM Init Failed:", err);
        }
    }

    // Клик по зоне открывает диалог выбора файла
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag & Drop эффекты
    ['dragover', 'dragenter'].forEach(name => {
        dropZone.addEventListener(name, (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });
    });

    ['dragleave', 'drop'].forEach(name => {
        dropZone.addEventListener(name, () => dropZone.classList.remove('active'));
    });

    // Обработка самого файла
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        handleFile(file);
    });

    fileInput.addEventListener('change', (e) => {
        handleFile(e.target.files[0]);
    });

    async function handleFile(file) {
        if (!file) return;

        updateStatus(`Обработка ${file.name}...`);
        
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const bytes = new Uint8Array(reader.result);
                const extension = file.name.split('.').pop().toLowerCase();

                // ВЫЗОВ ВАШЕГО RUST КОДА
                const result = process_replay_data(bytes, extension);

                if (result.error) {
                    updateStatus(result.error, 'error');
                } else {
                    updateStatus(result.info, 'success');
                }
            } catch (err) {
                updateStatus("Ошибка парсинга: " + err, "error");
            }
        };

        reader.onerror = () => updateStatus("Ошибка чтения файла с диска", "error");
        reader.readAsArrayBuffer(file);
    }

    // Запуск приложения
    startApp();
</script>

</body>
</html>
